<%- layout('layouts/boilerplate')  %>


<style>
    #map {
        /* position: absolute;
        top: 0;
        bottom: 0;
        width: 100%; */
        height: 60vh;
    }
</style>

<div class="row mb-1">
    <div class="col"></div>
    <div class="col"><span class="d-block text-center fs-1 fw-bold">Schedule</span></div>
    <div class="col text-end"><a href="/form" class="btn btn-primary mt-2">Add a new visit!</a></div>
</div>
<% if (visits.length > 0) { %> 
<table class="table table-striped table-hover text-center align-middle">
    <thead>
        <tr>
            <th class="col">No.</th>
            <th class="col">Host</th>
            <th class="col">Details</th>
            <th class="col">Start</th>
            <th class="col">End</th>
            <th class="col">Date</th>
        </tr>
        <tbody>
            <% for (let i = 0; i < visits.length; i++) { %>
                <tr>
                    <th><%= i + 1 %></th>
                    <td><%= visits[i].host.username %></td>
                    <td><%= visits[i].details %></td>
                    <td><%= visits[i].startTime.toLocaleTimeString() %></td>
                    <td><%= visits[i].endTime.toLocaleTimeString() %></td>
                    <td><%= visits[i].endTime.toLocaleDateString() %></td>
                </tr>
            <% } %>
        </tbody>
    </thead>
</table>
<% } else { %>
    <h2 class="text-center">No visits scheduled... schedule one now!</h2>
<% } %> 

<div class="row mb-1">
    <div class="col"></div>
    <div class="col"><span class="d-block text-center fs-1 fw-bold">Visiting me!</span></div>
    <div class="col"></div>
</div>
<% if (visits.length > 0) { %> 
<table class="table table-striped table-hover text-center align-middle">
    <thead>
        <tr>
            <th class="col">No.</th>
            <th class="col">Host</th>
            <th class="col">Details</th>
            <th class="col">Start</th>
            <th class="col">End</th>
            <th class="col">Date</th>
        </tr>
        <tbody>
            <% for (let i = 0; i < visits.length; i++) { %>
                <tr>
                    <th><%= i + 1 %></th>
                    <td><%= visits[i].host.username %></td>
                    <td><%= visits[i].details %></td>
                    <td><%= visits[i].startTime.toLocaleTimeString() %></td>
                    <td><%= visits[i].endTime.toLocaleTimeString() %></td>
                    <td><%= visits[i].endTime.toLocaleDateString() %></td>
                </tr>
            <% } %>
        </tbody>
    </thead>
</table>
<% } else { %>
    <h2 class="text-center">No one's visiting... for now!</h2>
<% } %> 

<div id='map'></div>

<button id="fit" class="btn btn-warning my-3">Fit to Singapore</button>
<!-- <style>
    #fit {
    display: block;
    position: relative;
    margin: 0px auto;
    padding: 15px;
    border: none;
    border-radius: 3px;
    font-size: 12px;
    text-align: center;
    color: #fff;
    background: #ee8a65;
    }
</style> -->

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamVyZWxkbGltankiLCJhIjoiY2tqbnA3OW93MDBubjJycGs0cHpvM3kxcyJ9.HEU7FAlbGjqEJByAUP-A8g';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v11', // stylesheet location
        center: [103.82, 1.364], // starting position [lng, lat]
        zoom: 11, // starting zoom
    });

    // Add geolocate control to the map
    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
            enableHighAccuracy: true
        },
            trackUserLocation: true
        })
    );

    document.getElementById('fit').addEventListener('click', function () {
        map.fitBounds([
            [103.6, 1.26],
            [104, 1.46]
        ]);
    });

    // adding markers
    // const marker = new mapboxgl.Marker()
    //     .setLngLat([103.8, 1.35])
    //     .addTo(map);
    
    // const test = <%- JSON.stringify(location) %>;
    // const newMarker = new mapboxgl.Marker()
    //     .setLngLat(test)
    //     .addTo(map)
    
    const visits = <%- JSON.stringify(visits) %>;

    visits.forEach(visit => {
        const newMarker = new mapboxgl.Marker()
        .setLngLat(visit.host.location)
        .setPopup(new mapboxgl.Popup().setHTML(`<h6>${visit.host.username}</h6><a href=${visit.host.link} target="blank">Visit Me</a><p>${visit.details}</p>`))
        .addTo(map)
    })
</script>
